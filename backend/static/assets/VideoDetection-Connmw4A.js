import{r as n,f as me,w as ge,o as _e,g as we,c as v,a as e,h as R,t as d,k as j,b as be,i as g,j as E,v as q,F as J,m as G,l as ke,E as M,e as u,n as K}from"./index-BszAOtP9.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";const xe={class:"detection-container"},Ce={class:"content-grid"},Re={class:"video-section"},Me={class:"video-card"},Fe={class:"video-header"},Le={key:0,class:"video-stats"},Se={class:"stat-badge fps"},Ve={class:"stat-badge time"},ze={class:"video-wrapper"},De={class:"video-controls"},Ee=["disabled"],Be=["disabled"],Te=["disabled"],He=["disabled"],We={class:"dropdown-wrapper"},Ae={class:"dropdown-menu"},Ie=["onClick"],Ne={class:"dropdown-wrapper"},$e={class:"dropdown-menu conf-menu"},Oe={class:"conf-slider-wrap"},Pe={class:"conf-value"},Ue={key:0,class:"file-info"},je={class:"info-section"},qe={class:"result-card"},Je={class:"detection-stats"},Ge={class:"detection-stat"},Ke={class:"stat-circle fire"},Qe={class:"stat-num"},Xe={class:"detection-stat"},Ye={class:"stat-circle smoke"},Ze={class:"stat-num"},et={class:"detection-list"},tt={class:"det-conf"},st={key:0,class:"empty-state"},at={__name:"VideoDetection",setup(lt){const o=n(null),_=n(null),F=n(null),h=n(null),c=n(!1),B=n(0),T=n(0),L=n(0),S=n(0),V=n([]),w=n(1),f=n(.5),b=n(!1),k=n(!1);let i=null,p=null,H=0,z=!1;const Q=10,X=1e3/Q,D=me(()=>V.value.filter(s=>s.confidence>=f.value));ge(D,s=>{L.value=s.filter(t=>t.class_name.toLowerCase().includes("fire")).length,S.value=s.filter(t=>t.class_name.toLowerCase().includes("smoke")).length});const W=s=>{s.target.closest(".dropdown-wrapper")||(b.value=!1,k.value=!1)};_e(()=>document.addEventListener("click",W)),we(()=>{y(),document.removeEventListener("click",W)});const A=()=>F.value.click(),Y=s=>{s.target.files[0]&&I(s.target.files[0])},Z=s=>{s.dataTransfer.files[0]&&I(s.dataTransfer.files[0])},I=s=>{h.value=s,o.value.src=URL.createObjectURL(s),M.success("视频加载成功")},ee=()=>{_.value.width=o.value.videoWidth,_.value.height=o.value.videoHeight,o.value.playbackRate=w.value},te=()=>{c.value&&(y(),M.info("视频播放结束"))},se=s=>{w.value=s,o.value&&(o.value.playbackRate=s),b.value=!1},ae=()=>{h.value&&oe()},y=()=>{c.value=!1,p&&(cancelAnimationFrame(p),p=null),i&&(i.close(),i=null),o.value&&o.value.pause(),ce()},le=()=>{y(),h.value=null,o.value&&(o.value.src=""),V.value=[],L.value=0,S.value=0,F.value.value=""},oe=()=>{i=new WebSocket(`ws://${window.location.hostname}:8000/ws/inference`),i.onopen=()=>{c.value=!0,o.value.playbackRate=w.value,o.value.play(),M.success("开始检测"),ne()},i.onmessage=s=>{z=!1;const t=JSON.parse(s.data);t.type==="result"&&ie(t.data)},i.onerror=()=>M.error("连接失败"),i.onclose=()=>{c.value=!1}},ne=()=>{const s=document.createElement("canvas"),t=s.getContext("2d"),a=()=>{if(!c.value||!i||i.readyState!==WebSocket.OPEN)return;const l=Date.now();if(l-H<X||z){p=requestAnimationFrame(a);return}const r=o.value;r&&r.videoWidth>0&&!r.paused&&(s.width=640,s.height=Math.round(640*r.videoHeight/r.videoWidth),t.drawImage(r,0,0,s.width,s.height),i.send(JSON.stringify({type:"frame",data:s.toDataURL("image/jpeg",.7).split(",")[1],conf_threshold:f.value,source_type:"video"})),z=!0,H=l),p=requestAnimationFrame(a)};p=requestAnimationFrame(a)},ie=s=>{B.value=s.fps||0,T.value=Math.round((s.processing_time||0)*1e3),V.value=s.stable_detections||[],de(s)},de=s=>{var $,O;const t=_.value,a=o.value;if(!t||!a)return;const l=t.getContext("2d");t.width=a.offsetWidth,t.height=a.offsetHeight,l.clearRect(0,0,t.width,t.height);const r=t.width/((($=s.image_size)==null?void 0:$.width)||a.videoWidth),N=t.height/(((O=s.image_size)==null?void 0:O.height)||a.videoHeight);(s.stable_detections||[]).filter(m=>m.confidence>=f.value).forEach(m=>{const[re,ve,ue,he]=m.bbox,x=re*r,C=ve*N,fe=ue*r,pe=he*N,P=m.class_name.toLowerCase().includes("fire")?"#ef4444":"#6b7280";l.strokeStyle=P,l.lineWidth=3,l.strokeRect(x,C,fe-x,pe-C);const U=`${m.class_name} ${(m.confidence*100).toFixed(0)}%`;l.font="bold 16px Inter, sans-serif",l.fillStyle=P,l.fillRect(x,C-26,l.measureText(U).width+14,24),l.fillStyle="#fff",l.fillText(U,x+7,C-7)})},ce=()=>{const s=_.value;s&&s.getContext("2d").clearRect(0,0,s.width,s.height)};return(s,t)=>(u(),v("div",xe,[t[19]||(t[19]=e("header",{class:"page-header"},[e("h1",{class:"page-title"},"视频检测"),e("p",{class:"page-desc"},"上传视频文件进行火灾烟雾检测分析")],-1)),e("div",Ce,[e("div",Re,[e("div",Me,[e("div",Fe,[t[4]||(t[4]=e("span",{class:"video-title"},"视频画面",-1)),c.value?(u(),v("div",Le,[e("span",Se,"FPS: "+d(B.value),1),e("span",Ve,d(T.value)+"ms",1)])):R("",!0)]),e("div",ze,[e("video",{ref_key:"videoRef",ref:o,class:"video-element",onLoadedmetadata:ee,onEnded:te,muted:""},null,544),e("canvas",{ref_key:"canvasRef",ref:_,class:"overlay-canvas"},null,512),h.value?R("",!0):(u(),v("div",{key:0,class:"video-placeholder upload-zone",onClick:A,onDragover:t[0]||(t[0]=j(()=>{},["prevent"])),onDrop:j(Z,["prevent"])},[...t[5]||(t[5]=[be('<div class="placeholder-icon" data-v-26a1e3aa><svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor" data-v-26a1e3aa><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" data-v-26a1e3aa></path></svg></div><p class="placeholder-text" data-v-26a1e3aa>拖拽视频文件到此处，或点击上传</p><p class="placeholder-hint" data-v-26a1e3aa>支持 MP4, AVI, MOV 等格式</p>',3)])],32))]),e("div",De,[e("button",{class:"btn btn-secondary",onClick:A,disabled:c.value},[...t[6]||(t[6]=[e("svg",{viewBox:"0 0 24 24",width:"20",height:"20",fill:"currentColor"},[e("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"})],-1),g(" 选择视频 ",-1)])],8,Ee),e("button",{class:"btn btn-primary",onClick:ae,disabled:!h.value||c.value},[...t[7]||(t[7]=[e("svg",{viewBox:"0 0 24 24",width:"20",height:"20",fill:"currentColor"},[e("path",{d:"M8 5v14l11-7z"})],-1),g(" 开始检测 ",-1)])],8,Be),e("button",{class:"btn btn-danger",onClick:y,disabled:!c.value},[...t[8]||(t[8]=[e("svg",{viewBox:"0 0 24 24",width:"20",height:"20",fill:"currentColor"},[e("path",{d:"M6 6h12v12H6z"})],-1),g(" 停止 ",-1)])],8,Te),e("button",{class:"btn btn-ghost",onClick:le,disabled:c.value},[...t[9]||(t[9]=[e("svg",{viewBox:"0 0 24 24",width:"20",height:"20",fill:"currentColor"},[e("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"})],-1),g(" 重置 ",-1)])],8,He),e("div",We,[e("button",{class:"btn btn-option",onClick:t[1]||(t[1]=a=>b.value=!b.value)},[t[10]||(t[10]=e("svg",{viewBox:"0 0 24 24",width:"20",height:"20",fill:"currentColor"},[e("path",{d:"M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.92 6-4.72 7.28L13 17v5h5l-1.22-1.22C19.91 19.07 22 15.76 22 12c0-5.18-3.95-9.45-9-9.95zM11 2.05C5.94 2.55 2 6.81 2 12c0 3.76 2.09 7.07 5.22 8.78L6 22h5v-5l-2.28 2.28C6.92 18 5 15.21 5 12c0-4.08 3.05-7.44 7-7.93V2.05z"})],-1)),g(" "+d(w.value)+"x ",1)]),E(e("div",Ae,[(u(),v(J,null,G([.5,1,1.5,2],a=>e("button",{key:a,class:K(["dropdown-item",{active:w.value==a}]),onClick:l=>se(a)},d(a)+"x ",11,Ie)),64))],512),[[q,b.value]])]),e("div",Ne,[e("button",{class:"btn btn-option",onClick:t[2]||(t[2]=a=>k.value=!k.value)},[t[11]||(t[11]=e("svg",{viewBox:"0 0 24 24",width:"20",height:"20",fill:"currentColor"},[e("path",{d:"M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"})],-1)),g(" "+d((f.value*100).toFixed(0))+"% ",1)]),E(e("div",$e,[e("div",Oe,[t[12]||(t[12]=e("span",{class:"conf-label"},"置信度阈值",-1)),E(e("input",{type:"range","onUpdate:modelValue":t[3]||(t[3]=a=>f.value=a),min:"0.1",max:"0.9",step:"0.05",class:"conf-slider"},null,512),[[ke,f.value]]),e("span",Pe,d((f.value*100).toFixed(0))+"%",1)])],512),[[q,k.value]])])]),h.value?(u(),v("div",Ue,[t[13]||(t[13]=e("svg",{viewBox:"0 0 24 24",width:"18",height:"18",fill:"currentColor"},[e("path",{d:"M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"})],-1)),e("span",null,d(h.value.name),1)])):R("",!0)])]),e("div",je,[e("div",qe,[t[17]||(t[17]=e("div",{class:"card-header"},[e("span",{class:"card-title"},"检测结果")],-1)),e("div",Je,[e("div",Ge,[e("div",Ke,[e("span",Qe,d(L.value),1)]),t[14]||(t[14]=e("span",{class:"stat-name"},"火焰",-1))]),e("div",Xe,[e("div",Ye,[e("span",Ze,d(S.value),1)]),t[15]||(t[15]=e("span",{class:"stat-name"},"烟雾",-1))])]),e("div",et,[(u(!0),v(J,null,G(D.value,(a,l)=>(u(),v("div",{key:l,class:"detection-item"},[e("span",{class:K(["det-tag",a.class_name.includes("fire")?"fire":"smoke"])},d(a.class_name),3),e("span",tt,d((a.confidence*100).toFixed(1))+"%",1)]))),128)),D.value.length===0?(u(),v("div",st,[...t[16]||(t[16]=[e("span",null,"暂无检测结果",-1)])])):R("",!0)])]),t[18]||(t[18]=e("div",{class:"tip-card"},[e("div",{class:"card-header"},[e("span",{class:"card-title"},"提示")]),e("p",{class:"tip-text"},"检测到的结果会自动保存到检测历史中，您可以在检测历史页面进行评定。")],-1))])]),e("input",{type:"file",ref_key:"fileInputRef",ref:F,accept:"video/*",style:{display:"none"},onChange:Y},null,544)]))}},ct=ye(at,[["__scopeId","data-v-26a1e3aa"]]);export{ct as default};
