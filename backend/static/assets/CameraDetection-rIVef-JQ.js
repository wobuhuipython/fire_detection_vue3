import{r as l,f as te,w as ae,o as oe,g as ne,c as h,a as e,h as R,t as i,n as O,i as M,j as U,k as le,v as ie,l as ce,F as de,m as re,E as D,e as m}from"./index-BszAOtP9.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ue={class:"detection-container"},fe={class:"content-grid"},pe={class:"video-section"},he={class:"video-card"},me={class:"video-header"},_e={key:0,class:"video-stats"},ge={class:"stat-badge fps"},we={class:"stat-badge time"},be={class:"video-wrapper"},xe={key:0,class:"video-placeholder"},ye={class:"video-controls"},ke=["disabled"],Ce=["disabled"],Fe={class:"dropdown-wrapper"},Se={class:"dropdown-menu conf-menu"},Re={class:"conf-slider-wrap"},Me={class:"conf-value"},De={class:"info-section"},Ee={class:"result-card"},Te={class:"detection-stats"},Le={class:"detection-stat"},ze={class:"stat-circle fire"},Be={class:"stat-num"},Ae={class:"detection-stat"},Ne={class:"stat-circle smoke"},Ve={class:"stat-num"},We={class:"detection-list"},Ie={class:"det-conf"},Oe={key:0,class:"empty-state"},Ue=10,je={__name:"CameraDetection",setup($e){const d=l(null),x=l(null),c=l(!1),v=l(!1),E=l(0),T=l(0),y=l(0),k=l(0),C=l([]),r=l(.5),g=l(!1);let _=null,n=null,u=null,L=0;const j=1e3/Ue;let F=!1;const S=te(()=>C.value.filter(t=>t.confidence>=r.value));ae(S,t=>{y.value=t.filter(s=>s.class_name.toLowerCase().includes("fire")).length,k.value=t.filter(s=>s.class_name.toLowerCase().includes("smoke")).length});const z=t=>{t.target.closest(".dropdown-wrapper")||(g.value=!1)};oe(()=>document.addEventListener("click",z)),ne(()=>{B(),document.removeEventListener("click",z)});const $=async()=>{v.value=!0;try{_=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}}),d.value.srcObject=_,await d.value.play(),q()}catch(t){D.error("无法访问摄像头: "+t.message),v.value=!1}},B=()=>{c.value=!1,u&&(cancelAnimationFrame(u),u=null),n&&(n.close(),n=null),_&&(_.getTracks().forEach(t=>t.stop()),_=null),d.value&&(d.value.srcObject=null),G(),C.value=[],y.value=0,k.value=0},q=()=>{const t=`ws://${window.location.hostname}:8000/ws/inference`;n=new WebSocket(t),n.onopen=()=>{c.value=!0,v.value=!1,D.success("连接成功"),H()},n.onmessage=s=>{F=!1;const a=JSON.parse(s.data);a.type==="result"&&P(a.data)},n.onerror=()=>{D.error("连接失败"),v.value=!1},n.onclose=()=>{c.value=!1}},H=()=>{const t=document.createElement("canvas"),s=t.getContext("2d"),a=()=>{if(!c.value||!n||n.readyState!==WebSocket.OPEN)return;const o=Date.now();if(o-L<j||F){u=requestAnimationFrame(a);return}const f=d.value;f&&f.videoWidth>0&&(t.width=640,t.height=480,s.drawImage(f,0,0,640,480),n.send(JSON.stringify({type:"frame",data:t.toDataURL("image/jpeg",.7).split(",")[1],conf_threshold:r.value,source_type:"camera"})),F=!0,L=o),u=requestAnimationFrame(a)};u=requestAnimationFrame(a)},P=t=>{E.value=t.fps||0,T.value=Math.round((t.processing_time||0)*1e3),C.value=t.stable_detections||[],J(t)},J=t=>{var N,V;const s=x.value,a=d.value;if(!s||!a)return;const o=s.getContext("2d");s.width=a.offsetWidth,s.height=a.offsetHeight,o.clearRect(0,0,s.width,s.height);const f=s.width/(((N=t.image_size)==null?void 0:N.width)||640),A=s.height/(((V=t.image_size)==null?void 0:V.height)||480);(t.stable_detections||[]).filter(p=>p.confidence>=r.value).forEach(p=>{const[K,Q,X,Y]=p.bbox,w=K*f,b=Q*A,Z=X*f,ee=Y*A,se=p.class_name.toLowerCase().includes("fire"),W=se?"#ef4444":"#6b7280";o.strokeStyle=W,o.lineWidth=3,o.strokeRect(w,b,Z-w,ee-b);const I=`${p.class_name} ${(p.confidence*100).toFixed(0)}%`;o.font="bold 14px Inter, sans-serif",o.fillStyle=W,o.fillRect(w,b-24,o.measureText(I).width+12,22),o.fillStyle="#fff",o.fillText(I,w+6,b-7)})},G=()=>{const t=x.value;t&&t.getContext("2d").clearRect(0,0,t.width,t.height)};return(t,s)=>(m(),h("div",ue,[s[13]||(s[13]=e("header",{class:"page-header"},[e("h1",{class:"page-title"},"摄像头检测"),e("p",{class:"page-desc"},"实时调用摄像头进行火灾烟雾检测")],-1)),e("div",fe,[e("div",pe,[e("div",he,[e("div",me,[s[2]||(s[2]=e("span",{class:"video-title"},"实时画面",-1)),c.value?(m(),h("div",_e,[e("span",ge,"FPS: "+i(E.value),1),e("span",we,i(T.value)+"ms",1)])):R("",!0)]),e("div",be,[e("video",{ref_key:"videoRef",ref:d,class:"video-element",autoplay:"",muted:"",playsinline:""},null,512),e("canvas",{ref_key:"canvasRef",ref:x,class:"overlay-canvas"},null,512),c.value?R("",!0):(m(),h("div",xe,[...s[3]||(s[3]=[e("div",{class:"placeholder-icon"},[e("svg",{viewBox:"0 0 24 24",width:"56",height:"56",fill:"currentColor"},[e("path",{d:"M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"})])],-1),e("p",{class:"placeholder-text"},"点击下方按钮启动摄像头",-1)])]))]),e("div",ye,[e("button",{class:O(["btn btn-primary",{loading:v.value}]),onClick:$,disabled:c.value},[s[4]||(s[4]=e("svg",{viewBox:"0 0 24 24",width:"18",height:"18",fill:"currentColor"},[e("path",{d:"M8 5v14l11-7z"})],-1)),M(" "+i(v.value?"启动中...":"开始检测"),1)],10,ke),e("button",{class:"btn btn-danger",onClick:B,disabled:!c.value},[...s[5]||(s[5]=[e("svg",{viewBox:"0 0 24 24",width:"18",height:"18",fill:"currentColor"},[e("path",{d:"M6 6h12v12H6z"})],-1),M(" 停止检测 ",-1)])],8,Ce),e("div",Fe,[e("button",{class:"btn btn-option",onClick:s[0]||(s[0]=le(a=>g.value=!g.value,["stop"]))},[s[6]||(s[6]=e("svg",{viewBox:"0 0 24 24",width:"20",height:"20",fill:"currentColor"},[e("path",{d:"M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"})],-1)),M(" "+i((r.value*100).toFixed(0))+"% ",1)]),U(e("div",Se,[e("div",Re,[s[7]||(s[7]=e("span",{class:"conf-label"},"置信度阈值",-1)),U(e("input",{type:"range","onUpdate:modelValue":s[1]||(s[1]=a=>r.value=a),min:"0.1",max:"0.9",step:"0.05",class:"conf-slider"},null,512),[[ce,r.value]]),e("span",Me,i((r.value*100).toFixed(0))+"%",1)])],512),[[ie,g.value]])])])])]),e("div",De,[e("div",Ee,[s[11]||(s[11]=e("div",{class:"card-header"},[e("span",{class:"card-title"},"检测结果")],-1)),e("div",Te,[e("div",Le,[e("div",ze,[e("span",Be,i(y.value),1)]),s[8]||(s[8]=e("span",{class:"stat-name"},"火焰",-1))]),e("div",Ae,[e("div",Ne,[e("span",Ve,i(k.value),1)]),s[9]||(s[9]=e("span",{class:"stat-name"},"烟雾",-1))])]),e("div",We,[(m(!0),h(de,null,re(S.value,(a,o)=>(m(),h("div",{key:o,class:"detection-item"},[e("span",{class:O(["det-tag",a.class_name.includes("fire")?"fire":"smoke"])},i(a.class_name),3),e("span",Ie,i((a.confidence*100).toFixed(1))+"%",1)]))),128)),S.value.length===0?(m(),h("div",Oe,[...s[10]||(s[10]=[e("span",null,"暂无检测结果",-1)])])):R("",!0)])]),s[12]||(s[12]=e("div",{class:"tip-card"},[e("div",{class:"card-header"},[e("span",{class:"card-title"},"提示")]),e("p",{class:"tip-text"},"检测到的结果会自动保存到检测历史中，您可以在检测历史页面进行评定。")],-1))])])]))}},Je=ve(je,[["__scopeId","data-v-7ff00a2e"]]);export{Je as default};
